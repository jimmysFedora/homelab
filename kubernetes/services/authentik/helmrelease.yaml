apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: authentik
  namespace: flux-system
spec:
  interval: 15m
  url: https://charts.goauthentik.io/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
  namespace: flux-system
spec:
  interval: 15m
  releaseName: authentik
  targetNamespace: default
  chart:
    spec:
      chart: authentik
      sourceRef:
        kind: HelmRepository
        name: authentik
        namespace: flux-system
  values:
    global:
      image:
        repository: ghcr.io/goauthentik/server
        tag: "2025.12.3"
        digest: "sha256:0e7e82b29a4c0899d0e2efa4a7a83452b48b6971faa3a87346f595ebf54fd74c"
        pullPolicy: IfNotPresent

      env:
        - name: AUTHENTIK_POSTGRESQL__HOST
          value: "authentik-postgresql"
        - name: AUTHENTIK_POSTGRESQL__USER
          value: "authentik"
        - name: AUTHENTIK_POSTGRESQL__NAME
          value: "authentik"
        - name: AUTHENTIK_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: "authentik-secrets"
              key: "secret_key"
        - name: AUTHENTIK_POSTGRESQL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: "authentik-secrets"
              key: "DB_PASS"

    authentik:
      existingSecret:
        secretName: "authentik-secrets"

    server:
      ingress:
        enabled: true
        ingressClassName: traefik
        hosts:
          - authentik.mistyfumes.dev
        tls:
          - secretName: prod-mistyfumes-tls
            hosts:
              - authentik.mistyfumes.dev

    postgresql:
      enabled: false

  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5